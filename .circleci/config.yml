version: 2.1

orbs:
  aws-cli: circleci/aws-cli@5.4.1  # orb oficial da AWS CLI
  aws-sam: circleci/aws-sam-serverless@6.1.0  # orb oficial do SAM
  snyk_scan: snyk/snyk@2.3.0 # orb oficial do Snyk

# Orchestrate jobs using workflows
# See: https://circleci.com/docs/guides/orchestrate/workflows/ & https://circleci.com/docs/reference/configuration-reference/#workflows
workflows:
  pad-workflow: # This is the name of the workflow, feel free to change it to better match your workflow.
    # Inside the workflow, you define the jobs you want to run.
    jobs:
      - build_node
      - snyk_scan:
          requires:
            - build_node
          context:
            - snyk-setup
      # - sam_deploy:
      #     requires:
      #       - snyk_scan
      #     context:
      #       - aws-credentials # contexto com AWS_* credenciais
      #       - aws-infra # contexto com variáveis de infraestrutura

# Define a job to be invoked later in a workflow.
# See: https://circleci.com/docs/guides/orchestrate/jobs-steps/#jobs-overview & https://circleci.com/docs/reference/configuration-reference/#jobs
jobs:
  build_node:
    # Specify the execution environment. You can specify an image from Docker Hub or use one of our convenience images from CircleCI's Developer Hub.
    docker:
      # Specify the version you desire here
      # See: https://circleci.com/developer/images/image/cimg/base
      - image: cimg/node:20.19
    # Add steps to the job
    # See: https://circleci.com/docs/guides/orchestrate/jobs-steps/#steps-overview & https://circleci.com/docs/reference/configuration-reference/#steps
    steps:
      # Checkout the code as the first step.
      - checkout
      - run: echo "$teste"
      - run: node -v
      - run: npm --version
      - run:
          name: Instalar dependências
          command: |
            if [ -f src/handlers/package-lock.json ]; then
              npm ci --prefix src/handlers
            else
              npm i --prefix src/handlers
            fi
      - persist_to_workspace:
          root: .
          paths:
            - .

  snyk_scan:
    docker:
      - image: cimg/node:20.19
    working_directory: ~/project/src/handlers
    steps:
      - attach_workspace:
          at: ~/project
      - run:
          name: debug
          command: |
            pwd
            ls -la
      - snyk_scan/install
      - snyk_scan/scan:
          project: pad-delete-circle

  sam_deploy:
    docker:
      - image: cimg/node:20.19
    steps:
      - run: cp infra/samconfig.toml ./samconfig.toml
      - aws-cli/setup
      - run: |
          aws configure set aws_access_key_id "$AWS_ACCESS_KEY_ID" --profile default
          aws configure set aws_secret_access_key "$AWS_SECRET_ACCESS_KEY" --profile default
          [ -n "$AWS_SESSION_TOKEN" ] && aws configure set aws_session_token "$AWS_SESSION_TOKEN" --profile default
          aws configure set region "${AWS_REGION:-us-east-1}" --profile default
      - run:
          name: Teste Permissões AWS
          command: |
           aws sts get-caller-identity --profile default
           aws s3 ls s3://bucket-sam-teste --profile default
      - aws-sam/install
      - aws-sam/build:
          validate: false
          use_container: false
          template: template.yaml
          debug: true
          region: us-east-1
      - aws-sam/deploy:
          region: us-east-1
          capabilities: "CAPABILITY_IAM"
          s3_bucket: bucket-sam-teste
          stack_name: $stack_name
          debug: true
          parameter_overrides: |
            customLambdaRole=$lambda_role_arn
          arguments: "--no-confirm-changeset --on-failure DELETE"
          


    